#!/bin/bash
#
# Update data
#
# Main script for building/updating the data files used by the viewer.
#

export DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd ".." && pwd )"
source "${DIR}/bin/config.sh"

function download {
   strain=$1
   url=$2
   fname=$3
   logit "Downloading:" "${url}" "to" "${fname}"
   curl -R -z ${fname} -o ${fname} $url 2>>${LOGFILE}
   checkExit
   #
}

function prepFile {
    strain=$1
    fname=$2
    gname=$3
    smpname=$4
    logit "Converting ${fname} to ${gname}"
    gunzip -c "${fname}" | python prepGffFile.py -s "${strain}" -v ${VALIDIDFILE} -m ${MAPPINGFILE} > "${gname}" 2>>${LOGFILE}
    checkExit
    logit "Creating sample ${smpname} from ${gname}"
    python makeSamples.py < ${gname} > "${smpname}" 2>>${LOGFILE}
}

function summarize {
    logit "Summarizing output files..."
    logit $*
    logit "Distinct chromosomes..."
    grep -v "#" $* | cut -f 1 | sort | uniq > ${WDIR}/chromosomes.txt
    checkExit
    logit "Distinct column 3 types..."
    grep -v "#" $* | cut -f 3 | sort | uniq > ${WDIR}/types.txt
    checkExit
    logit "Distinct types and biotypes (col 3 and col 9)..."
    grep -v "#" $* | grep biotype | cut -f 3,9 | sed "s/        .*biotype=\([^;]*\).*/    \1/" | sort | uniq > ${WDIR}/types_biotypes.txt
    checkExit
}

function main {
    # setup
    mkdir -p ${WDIR}; checkExit
    mkdir -p ${DDIR}; checkExit
    mkdir -p ${GDIR}; checkExit
    mkdir -p ${SDIR}; checkExit
    #
    #rm -f ${LOGFILE}
    touch ${LOGFILE}
    logit "=========================================="
    logit "Starting MGP GFF3 file preparation script."
    # generate file of valid MGI IDs
    logit "Generating valid MGI id..."
    python getValidMgiIds.py > ${VALIDIDFILE}; checkExit
    # generate secondary-to-primary mapping file for MGI ids
    logit "Generating MGI ID mapping file..."
    python getSecondaryIdMapping.py > ${MAPPINGFILE}; checkExit
    # loop through the strains config table
    logit "Starting loop..."
    while read -u 10 p; do
	IFS='	' read -r -a array <<< "${p}"
	strainid="${array[0]}"
	strain="${array[1]}"
	sfname="${array[2]}"
	url="${array[3]}"
	fname=`basename ${url}`
	fname="${DDIR}/${fname}"
	gname="${GDIR}/${sfname}.gff3"
	smpname="${SDIR}/${sfname}.sample.gff3"
        logit "Strain=" "${strain}"
	download "${strain}" "${url}" "${fname}"
	prepFile "${strain}" "${fname}" "${gname}" "${smpname}"
    done 10<${STRAINS}
    # summarize the results
    summarize ${GDIR}/*.gff3
    logit "Done. No errors detected."
}

###
main
###

# THE END
